[Unit]
Description=RAG Gateway (FastAPI)
After=network-online.target
Wants=network-online.target

# These are required dependencies for the gateway to function.
Requires=qdrant.service tei-embed.service tei-rerank.service vllm.service
After=qdrant.service tei-embed.service tei-rerank.service vllm.service

[Service]
Type=simple

# Must exist as a system user; install.sh is responsible for ensuring this.
User=rag
Group=rag

EnvironmentFile=-/etc/rag-gateway/env
WorkingDirectory=/opt/llm/rag-gateway

# Make sure core services are reachable.
ExecStartPre=/opt/llm/rag-gateway/bin/wait-http.sh --name qdrant --url http://127.0.0.1:6333/collections --method GET --timeout 60

# TEI readiness: validate the endpoint responds successfully to a trivial request.
ExecStartPre=/opt/llm/rag-gateway/bin/wait-http.sh --name tei-embed --url http://127.0.0.1:8081/v1/embeddings --method POST --json '{"model":"Qwen/Qwen3-Embedding-8B","input":"ready"}' --timeout 120
ExecStartPre=/opt/llm/rag-gateway/bin/wait-http.sh --name tei-rerank --url http://127.0.0.1:8082/v1/rerank --method POST --json '{"model":"Qwen/Qwen3-Reranker-8B","query":"ready","documents":["ready"]}' --timeout 120

# vLLM readiness:
# - /v1/models must be reachable
# - and must already list the configured generator model id ("generator")
ExecStartPre=/opt/llm/rag-gateway/bin/wait-http.sh --name vllm --url http://127.0.0.1:8000/v1/models --method GET --expect '"id"[[:space:]]*:[[:space:]]*"generator"' --timeout 120

# Start the gateway.
ExecStart=/opt/llm/rag-gateway/.venv/bin/python -m rag_gateway.app --config /etc/rag-gateway/config.yaml

Restart=on-failure
RestartSec=2

# Keep logs accessible via journalctl
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target

